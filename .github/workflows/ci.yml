name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # キャッシュ作成ジョブ
  prepare:
    name: Prepare
    runs-on: codebuild-github-runner-project-${{ github.run_id }}-${{ github.run_attempt }}
    environment: production
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Generate cache key
        id: cache-key
        run: |
          CACHE_KEY="cache-$(sha256sum .tool-versions uv.lock | sha256sum | cut -d' ' -f1)"
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "Cache key: $CACHE_KEY"

      - name: Cache dependencies
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.asdf
            ~/.cache/pip
            ~/.cache/uv
            ~/.cargo
            ~/.local/bin
            .venv
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            cache-
    
      - name: Setup asdf
        uses: asdf-vm/actions/setup@v4

      - name: Install tools via asdf
        run: |
          asdf plugin add python
          asdf install

      - name: Setup uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install Python dependencies
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv sync --dev

  # 静的解析ジョブ
  lint:
    name: Lint
    runs-on: codebuild-github-runner-project-${{ github.run_id }}-${{ github.run_attempt }}
    needs: prepare
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.asdf
            ~/.cache/pip
            ~/.cache/uv
            ~/.cargo
            ~/.local/bin
            .venv
          key: ${{ needs.prepare.outputs.cache-key }}
          restore-keys: |
            cache-

      - name: Setup asdf
        uses: asdf-vm/actions/setup@v4

      - name: Setup Python with asdf
        run: |
          asdf plugin add python || true
          asdf install

      - name: Setup uv
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run linting
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run ruff check .
          uv run ruff format --check .

  # ユニットテストジョブ
  unittest:
    name: Unit Tests
    runs-on: codebuild-github-runner-project-${{ github.run_id }}-${{ github.run_attempt }}
    needs: prepare
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.asdf
            ~/.cache/pip
            ~/.cache/uv
            ~/.cargo
            ~/.local/bin
            .venv
          key: ${{ needs.prepare.outputs.cache-key }}
          restore-keys: |
            cache-

      - name: Setup asdf
        uses: asdf-vm/actions/setup@v4

      - name: Setup Python with asdf
        run: |
          asdf plugin add python || true
          asdf install

      - name: Setup uv
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run tests
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run pytest modules/api/tests/ -v --cov=modules/api --cov-report=xml

  # SCAチェックジョブ（Trivy)
  sca_trivy:
    name: SCA (Trivy)
    runs-on: codebuild-github-runner-project-${{ github.run_id }}-${{ github.run_attempt }}
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run Trivy vulnerability scanner in fs mode
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          trivy-config: trivy-config.yaml

  # SASTチェックジョブ（Semgrep）
  sast_semgrep:
    name: SAST (Semgrep)
    runs-on: codebuild-github-runner-project-${{ github.run_id }}-${{ github.run_attempt }}
    needs: prepare
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.asdf
            ~/.cache/pip
            ~/.cache/uv
            ~/.cargo
            ~/.local/bin
            .venv
          key: ${{ needs.prepare.outputs.cache-key }}
          restore-keys: |
            cache-

      - name: Setup asdf
        uses: asdf-vm/actions/setup@v4

      - name: Setup Python with asdf
        run: |
          asdf plugin add python || true
          asdf install

      - name: Setup uv
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Run Semgrep SAST scan
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run semgrep scan --config=auto --error modules/

